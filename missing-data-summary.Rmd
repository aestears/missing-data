---
title: "Missing data summary"
author: "Matt T"
date:  "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(dplyr)
library(shinystan)
library(faux)
library(bayesplot)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(lubridate)
library(data.table)
library(Amelia)
library(tidyr)
library(MASS)
library(plyr)
library(ggplot2)
library(summarytools)
library(knitr)


options(scipen=999)

#setwd("C:/Users/mtrentman/IDrive-Sync/Postdoc/Estimating missing data/daily_predictions")
setwd("C:/Users/matt/IDrive-Sync/Postdoc/Estimating missing data/daily_predictions")
sp<-read.table('daily.predictions.filled.tsv',header = TRUE) ##Missing dates filled in
sp$date.f<-as.Date(sp$date.f,format="%Y-%m-%d")
sp$site_name<-as.character(sp$site_name)
#sp<-read.table(file = 'daily_predictions.tsv',header = TRUE) ##Raw data
sd<-read.table(file = 'site_data.tsv',header = TRUE)##Site data
sd$site_name<-as.character(sd$site_name)

##Function to switch font color depending on the output (HTML or PDF)
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}

```
### Missing data in the context of Appling et al. dataset
I filled in the dates with missing data in the Appling et al. paper by site $\cdot$ year and made a historgram of missing data frequencies. I am making the assumption that if data were measured at the beginning and end of the year then they were likley collecting data for the whole year. There are obviously flaws to that assumption but it was the easiest way to address whether data was missing because it was actively being collected or not. The `r colorize("red line", "red")` is the percent of missing data for entire 10 year Shatto Ditch dataset. 

``````{r figs, echo=FALSE, fig.cap="Figure caption: The histogram shows the percent of missing data for each site x year with data measured on the first and last day of the year.", fig.show="hold", out.width="50%"}
# Find sites --------------------------------------------------------------

###Count NAs
cdata <- ddply(sp, c("site_name", "year"), summarize,
               N    = length(GPP),
               N.miss= sum(is.na(GPP)),
               Prop.miss=round(sum(is.na(GPP))/length(GPP)*100))


##Find sites with low missing data
full.year<-subset(cdata, N==365)

###Summary of NAs               
#Histogram
hist(full.year$Prop.miss, main="Distribution of percent missing data from Appling et al. site*years", xlab="Percent missing data")
abline(v=40.1, col="red")

#summary stats
summary(full.year$Prop.miss)
```


Next, I searched the Appling et al dataset for the site $\cdot$ year(s) with least amount of missing data. There was not a site $\cdot$ year combination with a full year of data, but there were two with less than 3% of data missing. 

```{r echo=FALSE, results='asis'}
##Find sites with low missing data
low.miss<-cdata[which(cdata$N==365 & cdata$Prop.miss<4),]


cols<-c(1:2,4:5)
knitr::kable(low.miss[,cols], caption="Table header: Site x years with less than 3% of missing data", col.names=(c("Site", "Year","Missing data (count)", "Prop. of year missing")),row.names = FALSE)
```

Fortunately, they each have somewhat unique annual GPP trends.



```{r figures-side, echo=FALSE, fig.cap="Figure caption: Two sites with low missing data from Appling et al. Data points represent the estimate and the error bars are the 95% credible interval. The line is modeled light using Yard et al. 1995 (NOTE: Light is scaled to fit on the graph) ", fig.show="hold", out.width="50%"}

low.miss.1<-subset(sp, site_name==low.miss$site_name[1] & year==2016)
low.miss.2<-subset(sp, site_name==low.miss$site_name[2] & year==2016)

##Simulate light for each site
hms<-rep("12:00:00", times=length(low.miss.1$date))
low.miss.1$date<-as.POSIXct(paste(low.miss.1$date.f, hms),tryFormats = c("%Y-%m-%d %H:%M:%OS"))
low.miss.2$date<-as.POSIXct(paste(low.miss.2$date.f, hms),tryFormats = c("%Y-%m-%d %H:%M:%OS"))

##light
# From Yard et al. (1995) Ecological Modelling.  Remember your trig?  
# calculate light as umol photon m-2 s-1.
# Arguments are:  
# time = a date and time input (posixct object)
# lat = latitude of field site
# longobs = longitude of field site
# longstd = standard longitude of the field site (NOTE: watch daylight savings time!!!). For PST, longstd is be 120 degrees. But during PDT it is 105 degrees. MST is 105 deg. MDT is 90. 


# convert degrees to radians
radi<-function(degrees){(degrees*pi/180)}

# function to estimate light
lightest<- function (time, lat, longobs, longstd) {
  jday<-yday(time)
  E<- 9.87*sin(radi((720*(jday-81))/365)) - 7.53*cos(radi((360*(jday-81))/365)) - 1.5*sin(radi((360*(jday-81))/365))
  LST<-as.numeric(time-trunc(time))
  ST<-LST+(3.989/1440)*(longstd-longobs)+E/1440
  solardel<- 23.439*sin(radi(360*((283+jday)/365)))
  hourangle<-(0.5-ST)*360
  theta<- acos( sin(radi(solardel)) * sin(radi(lat)) + cos(radi(solardel)) * cos(radi(lat)) * cos(radi(hourangle)) )
  suncos<-ifelse(cos(theta)<0, 0, cos(theta))
  GI<- suncos*2326
  GI	
  
}
low.miss.1$sim.light<-lightest(time=low.miss.1$date, lat=sd$lat[sd$site_name==low.miss$site_name[1]], longobs=sd$lon[sd$site_name==low.miss$site_name[1]],longstd=75)
low.miss.2$sim.light<-lightest(time=low.miss.2$date, lat=sd$lat[sd$site_name==low.miss$site_name[2]], longobs=sd$lon[sd$site_name==low.miss$site_name[2]],longstd=75) 

par(mar=c(4,4,.1,.1))
###Plot site data and light

main1<-sd$long_name[sd$site_name==low.miss$site_name[1]]
year1<-sd$long_name[sd$site_name==low.miss$year[1]]
main2<-sd$long_name[sd$site_name==low.miss$site_name[2]]
ggplot(data=low.miss.1, aes(x=date, y=GPP))+
  geom_line(aes(x=date, y=sim.light/700))+
  geom_point(color="black", size=3)+
  geom_errorbar(aes(x=date,ymin=GPP.lower, ymax=GPP.upper), width=0.2, size=0.5)+
  theme(legend.position="top")+
  theme_classic()+
  theme(axis.title.x=element_text(size=18,colour = "black"))+
  theme(axis.title.y=element_text(size=18,colour = "black"))+
  theme(axis.text.y=element_text(size=18,colour = "black"))+
  theme(axis.text.x=element_text(size=18,colour = "black"))+
  theme(legend.position="top")+
  ylab("GPP")+
  xlab("Time (days)")+
  ylim(c(0,7))+
  ggtitle(paste0(sd$long_name[sd$site_name==low.miss$site_name[1]],"-"," ", 2016))+
  annotate(geom="text", x=low.miss.1$date[300],
  y=6,label=paste(low.miss$Prop.miss[1],"% of data missing"),color="red")                 

ggplot(data=low.miss.2, aes(x=date, y=GPP))+
  geom_point(color="black", size=3)+
  geom_line(aes(x=date, y=sim.light/700))+
  geom_errorbar(aes(x=date,ymin=GPP.lower, ymax=GPP.upper), width=0.2, size=0.5)+
  theme(legend.position="top")+
  theme_classic()+
  theme(axis.title.x=element_text(size=18,colour = "black"))+
  theme(axis.title.y=element_text(size=18,colour = "black"))+
  theme(axis.text.y=element_text(size=18,colour = "black"))+
  theme(axis.text.x=element_text(size=18,colour = "black"))+
  theme(legend.position="top")+
  ylab("GPP")+
  xlab("Time (days)")+
  ylim(c(0,7))+
  ggtitle(paste0(sd$long_name[sd$site_name==low.miss$site_name[2]],"-"," ", 2016))+
  annotate(geom="text", x=low.miss.2$date[300],
  y=6,label=paste(low.miss$Prop.miss[2],"% of data missing"),color="red")  

```
### Estimating missing data on real datasets
I filled in the dates with missing data in the Appling et al. paper by site $\cdot$ year. The histogram shows the percent of missing data for each site $\cdot$ year with data measured on the first and last day of the year. I am making the assumption that if data were measured at the beginning and end of the year then they were likley collecting data for the whole year. There are obviously flaws to that assumption but it was the easiest way to address whether data was missing because it was actively being collected or not. The `r colorize("red line", "red")` is the percent of missing data for entire 10 year Shatto Ditch dataset. 


